
'use client';

/**
 * @fileOverview This file defines a client-side function for generating a persona profile picture.
 */

import { callGeminiApi } from '@/lib/api-key-manager';
import { z } from 'zod';

export const GeneratePersonaProfilePictureInputSchema = z.object({
  personaName: z.string(),
  personaTraits: z.string(),
  personaBackstory: z.string(),
});
export type GeneratePersonaProfilePictureInput = z.infer<typeof GeneratePersonaProfilePictureInputSchema>;

export const GeneratePersonaProfilePictureOutputSchema = z.object({
  profilePictureDataUri: z.string(),
});
export type GeneratePersonaProfilePictureOutput = z.infer<typeof GeneratePersonaProfilePictureOutputSchema>;

export async function generatePersonaProfilePicture(input: GeneratePersonaProfilePictureInput): Promise<GeneratePersonaProfilePictureOutput> {
  const prompt = `You are an expert art director specializing in character portraits for social media. Your task is to generate a profile picture that is authentic and believable, but in a semi-realistic, digitally painted art style. It should not look like a photograph.

The style of the portrait should be directly inspired by the character's personality and backstory.
- For a professional or serious persona, create a clean, well-composed, painted headshot.
- For a casual, artistic, or adventurous persona, create a more dynamic painted portrait, perhaps with a more expressive pose or interesting lighting that reflects their hobby or environment.

**Style Instructions (CRITICAL):**
- **Art Style:** Generate a high-quality, semi-realistic, digitally painted portrait. Think modern concept art or a high-end graphic novel. It should have a clear artistic touch.
- **AVOID PHOTOREALISM:** Do not generate a photograph. The image must look like a digital painting.
- **Authenticity over Perfection:** Avoid overly airbrushed or generic "anime" looks. The character should feel unique and real, despite being illustrated.
- **Lighting:** Use natural or dramatic lighting that complements the character's mood and setting.
- **Background:** Keep the background simple, painterly, or contextually relevant to the character.

Use the following details to bring the character to life in their profile picture:

**Character Name:** ${input.personaName}

**Character Vibe & Traits:**
${input.personaTraits}

**Backstory Context:**
${input.personaBackstory}`;

  const requestBody = {
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: {
      responseModalities: ['TEXT', 'IMAGE'],
    },
  };

  // Use the specified model for image generation, as it's a specialized task.
  const response = await callGeminiApi<any>('gemini-2.0-flash-preview-image-generation:generateContent', requestBody);

  // The model returns image data in an 'inlineData' part.
  const imagePart = response.candidates?.[0]?.content?.parts?.find(
    (part: any) => part.inlineData
  );

  const imageData = imagePart?.inlineData;

  if (imageData?.data && imageData?.mimeType) {
    const dataUri = `data:${imageData.mimeType};base64,${imageData.data}`;
    return { profilePictureDataUri: dataUri };
  }

  // If image generation fails, the API might return a text explanation.
  const textPart = response.candidates?.[0]?.content?.parts?.find((part: any) => part.text)?.text;
  const reason = textPart ? `API Error: ${textPart}` : 'No image data was generated by the API.';
  
  console.error("Image generation failed. Full API response:", response);
  throw new Error(reason);
}

    